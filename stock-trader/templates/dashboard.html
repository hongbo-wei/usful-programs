<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Trading Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="alternate icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/static/dashboard.css">
</head>
<body>
<div class="container py-4">
    <div class="d-flex align-items-center mb-3">
        <i class="fa-solid fa-chart-line fa-2x me-2" style="color:#2a7be4;"></i>
        <h1 class="dashboard-title mb-0">Trading Dashboard <span style="font-size:1.2rem;">üßë‚Äçüíª</span></h1>
    </div>
    <div class="row mb-3 g-3">
        <div class="col-12 col-md-3">
            <div class="metric-card text-center">
                <div class="metric-label">Initial Fund</div>
                <div class="metric-value"><i class="fa-solid fa-vault me-1"></i>${{ '{:,.2f}'.format(initial_fund) }}</div>
            </div>
        </div>
        <div class="col-12 col-md-3">
            <div class="metric-card text-center">
                <div class="metric-label">Cash Balance</div>
                <div class="metric-value"><i class="fa-solid fa-wallet me-1"></i>${{ '{:,.2f}'.format(cash_balance) }}</div>
            </div>
        </div>
        <div class="col-12 col-md-3">
            <div class="metric-card text-center">
                <div class="metric-label">Position Value</div>
                <div class="metric-value"><i class="fa-solid fa-coins me-1"></i>${{ '{:,.2f}'.format(position_value) }}</div>
            </div>
        </div>
        <div class="col-12 col-md-3">
            <div class="metric-card text-center">
                <div class="metric-label">Total Asset Value</div>
                <div class="metric-value"><i class="fa-solid fa-sack-dollar me-1"></i>${{ '{:,.2f}'.format(total_asset_value) }}</div>
            </div>
        </div>
    </div>
    <div class="row mb-3 g-3">
        <div class="col-12 col-md-6">
            <div class="metric-card text-center">
                <div class="metric-label">P&amp;L</div>
                <div class="metric-value {{ 'pnl-neg' if pnl < 0 else 'pnl-pos' }}">
                    <i class="fa-solid fa-arrow-trend-up me-1"></i>${{ '{:,.2f}'.format(pnl) }}
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="metric-card text-center">
                <div class="metric-label">ROI</div>
                <div class="metric-value {{ 'roi-neg' if pnl < 0 else 'roi-pos' }}">
                    <i class="fa-solid fa-percent me-1"></i>{{ roi }}
                </div>
            </div>
        </div>
    </div>
    <hr>
    <!-- Chart Display -->
    <div class="row mb-3 g-3">
        <div class="col-12 col-md-7">
            <div class="metric-card">
                <div class="metric-label">Stock & Crypto Buy vs Market Value</div>
                {% if asset_bar_chart %}
                <img src="data:image/png;base64,{{ asset_bar_chart }}" class="img-fluid" alt="Asset Bar Chart">
                <div class="mt-2" style="font-size:0.98em;">
                    <span class="me-3"><b>Stock:</b> Market/Buy = 
                        {% if stock_buy and stock_market %}
                            {{ '%.2f' % (stock_market / stock_buy * 100) if stock_buy else '0.00' }}%
                        {% else %}N/A{% endif %}
                    </span>
                    <span><b>Crypto:</b> Market/Buy = 
                        {% if crypto_buy and crypto_market %}
                            {{ '%.2f' % (crypto_market / crypto_buy * 100) if crypto_buy else '0.00' }}%
                        {% else %}N/A{% endif %}
                    </span>
                </div>
                {% else %}<div class="text-muted">No data</div>{% endif %}
            </div>
        </div>
        <div class="col-12 col-md-5">
            <div class="metric-card d-flex flex-column align-items-center justify-content-center" style="height:100%; min-height:350px;">
                {% if position_pie_chart %}
                <img src="data:image/png;base64,{{ position_pie_chart }}" class="img-fluid" alt="Position Pie Chart" style="max-width:95%; max-height:320px;">
                {% else %}<div class="text-muted">No data</div>{% endif %}
            </div>
        </div>
    </div>
    <!-- Market Data -->
    <div class="section-title"><i class="fa-solid fa-globe me-1"></i>Live Market Data</div>
    <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm bg-white align-middle">
            <thead><tr><th>Symbol</th><th>Price</th></tr></thead>
            <tbody>
            {% for row in market_rows %}
                <tr>
                    <td><span class="badge bg-primary bg-opacity-10 text-primary fw-bold">{{ row.Symbol }}</span></td>
                    <td><span class="fw-semibold">{{ row.Price }}</span></td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <hr>
    <!-- Trade Form -->
    <div class="section-title"><i class="fa-solid fa-right-left me-1"></i>Trade Operation</div>
    <form method="post" action="/trade" class="row g-3 align-items-center mb-3">
        {# CSRF token Âè™Â∫î‰Ωú‰∏∫ÈöêËóèÂ≠óÊÆµÊèíÂÖ•Ôºå‰∏çÂ∫îË¢´ËØØÊ∏≤Êüì‰∏∫ÊñáÊú¨ #}
        <!-- CSRF hidden fieldÔºåÂøÖÈ°ªÊîæÂú®Ë°®ÂçïinputÂå∫ÂüüÂÜÖ -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() | safe }}">
        <div class="col-auto">
            <select name="symbol" class="form-select">
                {% for s in symbols %}
                <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-auto">
            <select name="trade_type" class="form-select">
                <option value="Buy">Buy</option>
                <option value="Sell">Sell</option>
            </select>
        </div>
        <div class="col-auto">
            <input type="number" name="quantity" min="1" value="1" class="form-control" required>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">Submit Trade</button>
        </div>
    </form>

    <!-- Êô∫ËÉΩÂàÜÊûêËá™Âä®Â±ïÁ§∫ÂÖ•Âè£ -->
    <div class="row mb-3 g-3">
        <div class="col-12">
            {% if llm_answer %}
                <div class="alert alert-info mb-2"><b>Êô∫ËÉΩ‰ΩìÂª∫ËÆÆÔºö</b>{{ llm_answer }}</div>
                <button id="llm-analysis-btn" class="btn btn-info btn-sm ms-2">Êô∫ËÉΩÂàÜÊûê</button>
                <span id="llm-analysis-loading" style="display:none;">ÂàÜÊûê‰∏≠...</span>
                <div id="llm-analysis-result" class="alert alert-info mt-2" style="display:none;"></div>
                <form method="post" action="/auto_trade" style="display:inline;">
                    <input type="hidden" name="llm_answer" value="{{ llm_answer }}">
                    <button type="submit" class="btn btn-warning btn-sm ms-2">Êô∫ËÉΩ‰∫§Êòì</button>
                </form>
                {% if auto_trade_result %}
                  <div class="alert alert-success mt-2">{{ auto_trade_result }}</div>
                {% endif %}
            {% else %}
                <button id="llm-analysis-btn" class="btn btn-info btn-sm">Êô∫ËÉΩÂàÜÊûê</button>
                <span id="llm-analysis-loading" style="display:none;">ÂàÜÊûê‰∏≠...</span>
                <div id="llm-analysis-result" class="alert alert-info mt-2" style="display:none;"></div>
            {% endif %}
        </div>
    </div>
    <!-- Show current price for selected symbol -->
    <div id="current-price" class="mb-3 ps-2 fw-semibold text-primary"></div>
    <script>
      // Pass market_rows to JS as a global variable for dashboard.js
      window.marketRows = {
        {% for row in market_rows %}
        '{{ row.Symbol }}': {{ row.Price|default('null') }},
        {% endfor %}
      };
    </script>
    <script src="/static/dashboard.js"></script>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    <hr>
    <!-- Position Details -->
    <div class="section-title"><i class="fa-solid fa-boxes-stacked me-1"></i>Position Details</div>
    {% if position_rows %}
    <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm bg-white align-middle">
            <thead><tr><th>Symbol</th><th>Buy Date</th><th>Buy Price</th><th>Current Price</th><th>Quantity</th><th>Market Value</th><th>P&L</th></tr></thead>
            <tbody>
            {% for row in position_rows %}
                <tr>
                    <td><span class="badge bg-primary bg-opacity-10 text-primary fw-bold">{{ row.Symbol }}</span></td>
                    <td>{{ row['Buy Date'] }}</td>
                    <td>{{ row['Buy Price'] }}</td>
                    <td>{{ row['Current Price'] }}</td>
                    <td>{{ row.Quantity }}</td>
                    <td>{{ row['Market Value'] }}</td>
                    <td class="{{ 'pnl-neg' if row['P&L'] < 0 else 'pnl-pos' }}">{{ row['P&L'] }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <div class="alert alert-info">No position.</div>
    {% endif %}
    <hr>
    <!-- Recent Trades -->
    <div class="section-title"><i class="fa-solid fa-clock-rotate-left me-1"></i>Recent Trades</div>
    {% if trades %}
    <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm bg-white align-middle">
            <thead><tr><th>ID</th><th>Symbol</th><th>Type</th><th>Quantity</th><th>Price</th><th>Timestamp</th></tr></thead>
            <tbody>
            {% for t in trades %}
                <tr>
                    <td>{{ t.id }}</td>
                    <td><span class="badge bg-primary bg-opacity-10 text-primary fw-bold">{{ t.symbol }}</span></td>
                    <td>{{ t.type }}</td>
                    <td>{{ t.quantity }}</td>
                    <td>{{ t.price }}</td>
                    <td>{{ t.timestamp }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <div class="alert alert-info">No trades yet.</div>
    {% endif %}
    <hr>
    <!-- Êìç‰ΩúÊó•ÂøóÂ±ïÁ§∫ -->
    <div class="section-title"><i class="fa-solid fa-file-lines me-1"></i>Êìç‰ΩúÊó•Âøó</div>
    <div class="bg-light p-2 mb-4" style="max-height:300px;overflow:auto;font-size:0.95em;">
        {% if logs %}
            <pre style="white-space:pre-wrap;word-break:break-all;">{% for line in logs %}{{ line }}{% endfor %}</pre>
        {% else %}
            <div class="text-muted">ÊöÇÊó†Êó•Âøó</div>
        {% endif %}
    </div>
</div>
</body>
</html>
